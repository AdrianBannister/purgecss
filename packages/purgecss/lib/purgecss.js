"use strict";function _interopDefault(e){return e&&"object"==typeof e&&"default"in e?e.default:e}function _interopNamespace(e){if(e&&e.__esModule)return e;var t={};return e&&Object.keys(e).forEach((function(o){var r=Object.getOwnPropertyDescriptor(e,o);Object.defineProperty(t,o,r.get?r:{enumerable:!0,get:function(){return e[o]}})})),t.default=e,t}Object.defineProperty(exports,"__esModule",{value:!0});var postcss=require("postcss"),selectorParser=_interopDefault(require("postcss-selector-parser")),fs=require("fs"),glob=_interopDefault(require("glob")),path=_interopDefault(require("path"));const defaultOptions={css:[],content:[],defaultExtractor:e=>e.match(/[A-Za-z0-9_-]+/g)||[],extractors:[],fontFace:!1,keyframes:!1,rejected:!1,stdin:!1,stdout:!1,variables:!1,whitelist:[],whitelistPatterns:[],whitelistPatternsChildren:[]},IGNORE_ANNOTATION_CURRENT="purgecss ignore current",IGNORE_ANNOTATION_NEXT="purgecss ignore",IGNORE_ANNOTATION_START="purgecss start ignore",IGNORE_ANNOTATION_END="purgecss end ignore",CONFIG_FILENAME="purgecss.config.js",ERROR_CONFIG_FILE_LOADING="Error loading the config file",CSS_WHITELIST=["*","::-webkit-scrollbar","::selection",":root","::before","::after"],SELECTOR_STANDARD_TYPES=["class","id","universal","pseudo"];let ignore=!1;const atRules={fontFace:[],keyframes:[]},usedAnimations=new Set,usedFontFaces=new Set,selectorsRemoved=new Set;async function setOptions(e=CONFIG_FILENAME){let t;try{const o=path.join(process.cwd(),e);t=await new Promise((function(e){e(_interopNamespace(require(o)))}))}catch(e){throw new Error(`${ERROR_CONFIG_FILE_LOADING} ${e.message}`)}return{...defaultOptions,...t}}function setPurgeCSSOptions(e){exports.options=e}async function purge(e){exports.options="object"!=typeof e?await setOptions(e):{...defaultOptions,...e};const{content:t,css:o,extractors:r}=exports.options,s=t.filter(e=>"string"==typeof e),n=t.filter(e=>"object"==typeof e),i=await extractSelectorsFromFiles(s,r),a=extractSelectorsFromString(n,r);return getPurgedCSS(o,new Set([...i,...a]))}function extractSelectors(e,t){const o=new Set(t(e));return o.delete(""),o}async function extractSelectorsFromFiles(e,t){let o=new Set;for(const r of e){let e=[];try{await fs.promises.access(r,fs.constants.F_OK),e.push(r)}catch(t){e=glob.sync(r)}for(const r of e){const e=extractSelectors(await fs.promises.readFile(r,"utf-8"),getFileExtractor(r,t));o=new Set([...o,...e])}}return o}function extractSelectorsFromString(e,t){let o=new Set;for(const{raw:r,extension:s}of e){const e=extractSelectors(r,getFileExtractor(`.${s}`,t));o=new Set([...o,...e])}return o}function getFileExtractor(e,t){const o=t.find(t=>t.extensions.find(t=>e.endsWith(t)));return void 0===o?exports.options.defaultExtractor:o.extractor}async function getPurgedCSS(e,t){const o=[],r=[];for(const t of e)"string"==typeof t?r.push(...glob.sync(t)):r.push(t);for(const e of r){const r="string"==typeof e?exports.options.stdin?e:await fs.promises.readFile(e,"utf-8"):e.raw,s=postcss.parse(r);walkThroughCSS(s,t),exports.options.fontFace&&removeUnusedFontFaces(),exports.options.keyframes&&removeUnusedKeyframes();const n={css:s.toString(),file:"string"==typeof e?e:void 0};"string"==typeof e&&(n.file=e),exports.options.rejected&&(n.rejected=Array.from(selectorsRemoved),selectorsRemoved.clear()),o.push(n)}return o}function getSelectorsInRule(e){const t=new Set;if(e.parent&&":not"===e.parent.value&&"pseudo"===e.parent.type)return t;for(const{type:o,value:r}of e.nodes)SELECTOR_STANDARD_TYPES.includes(o)&&void 0!==r?t.add(r):"tag"!==o||void 0===r||/[+]|n|-|(even)|(odd)|^from$|^to$|^\d/.test(r)||t.add(r);return t}function evaluateAtRule(e){if(exports.options.keyframes&&e.name.endsWith("keyframes"))atRules.keyframes.push(e);else if(exports.options.fontFace&&"font-face"===e.name&&e.nodes)for(const t of e.nodes)"decl"===t.type&&"font-family"===t.prop&&atRules.fontFace.push({name:stripQuotes(t.value),node:e})}async function evaluateRule(e,t){const o=e.prev();if(ignore)return;if(o&&"comment"===o.type&&isIgnoreAnnotation(o,"next"))return void o.remove();if(e.parent&&"atrule"===e.parent.type&&"keyframes"===e.parent.name)return;if("rule"===e.type&&hasIgnoreAnnotation(e))return;if("rule"!==e.type)return;let r=!0;if(e.selector=selectorParser(e=>{e.walk(e=>{if("selector"!==e.type)return;const o=getSelectorsInRule(e);(r=shouldKeepSelector(t,o))||(exports.options.rejected&&selectorsRemoved.add(e.toString()),e.remove())})}).processSync(e.selector),r&&void 0!==e.nodes)for(const t of e.nodes){if("decl"!==t.type)continue;const{prop:e,value:o}=t;if(exports.options.keyframes&&("animation"===e||"animation-name"===e))for(const e of o.split(/[\s,]+/))usedAnimations.add(e);if(exports.options.fontFace&&"font-family"===e)for(const e of o.split(",")){const t=stripQuotes(e.trim());usedFontFaces.add(t)}}const s=e.parent;e.selector||e.remove(),isRuleEmpty(s)&&s.remove()}function isIgnoreAnnotation(e,t){switch(t){case"next":return e.text.includes(IGNORE_ANNOTATION_NEXT);case"start":return e.text.includes(IGNORE_ANNOTATION_START);case"end":return e.text.includes(IGNORE_ANNOTATION_END)}}function isRuleEmpty(e){return!!("rule"===e.type&&!e.selector||e.nodes&&!e.nodes.length||"atrule"===e.type&&(!e.nodes&&!e.params||!e.params&&e.nodes&&!e.nodes.length))}function isSelectorWhitelisted(e){return CSS_WHITELIST.includes(e)||exports.options.whitelist&&exports.options.whitelist.some(t=>t===e)||exports.options.whitelistPatterns&&exports.options.whitelistPatterns.some(t=>t.test(e))}function isSelectorWhitelistedChildren(e){return exports.options.whitelistPatternsChildren&&exports.options.whitelistPatternsChildren.some(t=>t.test(e))}function hasIgnoreAnnotation(e){let t=!1;return e.walkComments(e=>{e&&"comment"===e.type&&e.text.includes(IGNORE_ANNOTATION_CURRENT)&&(t=!0,e.remove())}),t}function removeUnusedFontFaces(){for(const{name:e,node:t}of atRules.fontFace)usedFontFaces.has(e)||t.remove()}function removeUnusedKeyframes(){for(const e of atRules.keyframes)usedAnimations.has(e.params)||e.remove()}function shouldKeepSelector(e,t){for(const o of t){const t=o.replace(/\\/g,"");if(!t.startsWith(":")){if(isSelectorWhitelistedChildren(t))return!0;if(!(e.has(t)||CSS_WHITELIST.includes(t)||isSelectorWhitelisted(t)))return!1}}return!0}function stripQuotes(e){return e.replace(/(^["'])|(["']$)/g,"")}function walkThroughCSS(e,t){e.walk(e=>"rule"===e.type?evaluateRule(e,t):"atrule"===e.type?evaluateAtRule(e):void("comment"===e.type&&(isIgnoreAnnotation(e,"start")?(ignore=!0,e.remove()):isIgnoreAnnotation(e,"end")&&(ignore=!1,e.remove()))))}exports.default=purge,exports.extractSelectorsFromFiles=extractSelectorsFromFiles,exports.extractSelectorsFromString=extractSelectorsFromString,exports.removeUnusedFontFaces=removeUnusedFontFaces,exports.removeUnusedKeyframes=removeUnusedKeyframes,exports.selectorsRemoved=selectorsRemoved,exports.setOptions=setOptions,exports.setPurgeCSSOptions=setPurgeCSSOptions,exports.walkThroughCSS=walkThroughCSS;
