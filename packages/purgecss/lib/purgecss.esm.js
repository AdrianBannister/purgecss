import{parse as e}from"postcss";import t from"postcss-selector-parser";import{promises as n,constants as r}from"fs";import s from"glob";import a from"path";const o={css:[],content:[],defaultExtractor:e=>{const t=e.match(/[A-Za-z0-9_-]+/g)||[];return{attributes:{names:new Set,values:new Set},classes:new Set,ids:new Set,tags:new Set,undetermined:new Set(t)}},extractors:[],fontFace:!1,keyframes:!1,rejected:!1,stdin:!1,stdout:!1,variables:!1,whitelist:[],whitelistPatterns:[],whitelistPatternsChildren:[]},i="purgecss ignore current",u="purgecss ignore",c="purgecss start ignore",f="purgecss end ignore",l="purgecss.config.js",d="Error loading the config file",m=["*","::-webkit-scrollbar","::selection",":root","::before","::after"];let p,w=!1;const y={fontFace:[],keyframes:[]},v=new Set,h=new Set,g=new Set;async function S(e=l){let t;try{const n=a.join(process.cwd(),e);t=await import(n)}catch(e){throw new Error(`${d} ${e.message}`)}return{...o,...t}}function b(e){p=e}function k(e,t){return t(e)}async function x(e,t){let a={attributes:{names:new Set,values:new Set},classes:new Set,ids:new Set,tags:new Set,undetermined:new Set};for(const o of e){let e=[];try{await n.access(o,r.F_OK),e.push(o)}catch(t){e=s.sync(o)}for(const r of e){a=C(a,k(await n.readFile(r,"utf-8"),F(r,t)))}}return a}function A(e,t){let n={attributes:{names:new Set,values:new Set},classes:new Set,ids:new Set,tags:new Set,undetermined:new Set};for(const{raw:r,extension:s}of e){n=C(n,k(r,F(`.${s}`,t)))}return n}function F(e,t){const n=t.find(t=>t.extensions.find(t=>e.endsWith(t)));return void 0===n?p.defaultExtractor:n.extractor}async function j(e,n){if(w)return;const r=e.prev();if(r&&"comment"===r.type&&P(r,"next"))return void r.remove();if(e.parent&&"atrule"===e.parent.type&&"keyframes"===e.parent.name)return;if("rule"!==e.type)return;if(function(e){let t=!1;return e.walkComments(e=>{e&&"comment"===e.type&&e.text.includes(i)&&(t=!0,e.remove())}),t}(e))return;let s=!0;if(e.selector=t(e=>{e.walk(e=>{"selector"===e.type&&((s=function(e,t){if(function(e){return e.parent&&"pseudo"===e.parent.type&&":not"===e.parent.value}(e))return!0;let n=!1;for(const a of e.nodes){if(a.value&&$(a.value))return!0;if(a.value&&(m.includes(a.value)||W(a.value)))n=!0;else{switch(a.type){case"attribute":n="value"===a.attribute||O(a,t);break;case"class":r=a,n=(s=t).classes.has(r.value)||s.undetermined.has(r.value);break;case"id":n=Z(a,t);break;case"tag":n=q(a,t)}if(!n)return!1}}var r,s;return n}(e,n))||(p.rejected&&g.add(e.toString()),e.remove()))})}).processSync(e.selector),s&&void 0!==e.nodes)for(const t of e.nodes){if("decl"!==t.type)continue;const{prop:e,value:n}=t;if(p.keyframes&&("animation"===e||"animation-name"===e))for(const e of n.split(/[\s,]+/))v.add(e);if(p.fontFace&&"font-family"===e)for(const e of n.split(",")){const t=z(e.trim());h.add(t)}}const a=e.parent;e.selector||e.remove(),function(e){if("rule"===e.type&&!e.selector||e.nodes&&!e.nodes.length||"atrule"===e.type&&(!e.nodes&&!e.params||!e.params&&e.nodes&&!e.nodes.length))return!0;return!1}(a)&&a.remove()}function P(e,t){switch(t){case"next":return e.text.includes(u);case"start":return e.text.includes(c);case"end":return e.text.includes(f)}}function W(e){return m.includes(e)||p.whitelist&&p.whitelist.some(t=>t===e)||p.whitelistPatterns&&p.whitelistPatterns.some(t=>t.test(e))}function $(e){return p.whitelistPatternsChildren&&p.whitelistPatternsChildren.some(t=>t.test(e))}function C(e,t){return{attributes:{names:new Set([...e.attributes.names,...t.attributes.names]),values:new Set([...e.attributes.values,...t.attributes.values])},classes:new Set([...e.classes,...t.classes]),ids:new Set([...e.ids,...t.ids]),tags:new Set([...e.tags,...t.tags]),undetermined:new Set([...e.undetermined,...t.undetermined])}}function E(){for(const{name:e,node:t}of y.fontFace)h.has(e)||t.remove()}function _(){for(const e of y.keyframes)v.has(e.params)||e.remove()}function z(e){return e.replace(/(^["'])|(["']$)/g,"")}function K(e,t){e.walk(e=>"rule"===e.type?j(e,t):"atrule"===e.type?function(e){if(p.keyframes&&e.name.endsWith("keyframes"))y.keyframes.push(e);else if(p.fontFace&&"font-face"===e.name&&e.nodes)for(const t of e.nodes)"decl"===t.type&&"font-family"===t.prop&&y.fontFace.push({name:z(t.value),node:e})}(e):void("comment"===e.type&&(P(e,"start")?(w=!0,e.remove()):P(e,"end")&&(w=!1,e.remove()))))}function O(e,t){if(!t.attributes.names.has(e.attribute)&&!t.undetermined.has(e.attribute))return!1;switch(e.operator){case"$=":return Array.from(t.attributes.values).some(t=>t.endsWith(e.value))||Array.from(t.undetermined).some(t=>t.endsWith(e.value));case"~=":case"*=":return Array.from(t.attributes.values).some(t=>t.includes(e.value))||Array.from(t.undetermined).some(t=>t.includes(e.value));case"=":return Array.from(t.attributes.values).some(t=>t===e.value)||Array.from(t.undetermined).some(t=>t===e.value);case"|=":case"^=":return Array.from(t.attributes.values).some(t=>t.startsWith(e.value))||Array.from(t.undetermined).some(t=>t.startsWith(e.value));default:return!0}}function Z(e,t){return t.ids.has(e.value)||t.undetermined.has(e.value)}function q(e,t){return t.tags.has(e.value)||t.undetermined.has(e.value)}export default async function(t){p="object"!=typeof t?await S(t):{...o,...t};const{content:r,css:a,extractors:i}=p,u=r.filter(e=>"string"==typeof e),c=r.filter(e=>"object"==typeof e);return async function(t,r){const a=[],o=[];for(const e of t)"string"==typeof e?o.push(...s.sync(e)):o.push(e);for(const t of o){const s="string"==typeof t?p.stdin?t:await n.readFile(t,"utf-8"):t.raw,o=e(s);K(o,r),p.fontFace&&E(),p.keyframes&&_();const i={css:o.toString(),file:"string"==typeof t?t:void 0};"string"==typeof t&&(i.file=t),p.rejected&&(i.rejected=Array.from(g),g.clear()),a.push(i)}return a}(a,C(await x(u,i),A(c,i)))}export{o as defaultOptions,x as extractSelectorsFromFiles,A as extractSelectorsFromString,C as mergeExtractorSelectors,E as removeUnusedFontFaces,_ as removeUnusedKeyframes,g as selectorsRemoved,S as setOptions,b as setPurgeCSSOptions,K as walkThroughCSS};
